<!DOCTYPE html>
<html lang='eng'>

<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta http-equiv="x-ua-compatible" content='ie=edge'>
    <title>Friend Library</title>
    <link rel='stylesheet' type='text/css' href='resources/css/reset.css'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel='stylesheet' type='text/css' href='resources/css/style.css'>
    <script src="https://kit.fontawesome.com/a230460b96.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
</head>

<body>

    <header>

    </header>

    <div id='login-page'>

      <h1 id='page-title'>Friend Library</h1>

      <button id='authorize-button' onclick="authorizeGoogleAccess()" class='button'>Login</button>

    </div>

    <main id='main'>

        <pre id='content'></pre>
        
        <div id='selected-book-container'>

          <h1 id='selected-title'>Book Title</h1>

          <h2 id='selected-author'>Author</h2>

          <div class='status' id='selected-status'>status</div>

          <p class='selected-info'>Fiction</p>
          <p class='selected-info'>TW: </p>

          <a id='goodreads-link'></a>

        </div>

    </main>

    <script type='text/javascript'>

      function inlineToggle(obj) {
          if ($(obj).css('display') == 'none') {
              $(obj).slideToggle();
              $(obj).css({
                  display: 'inline-flex',
                  flexDirection: 'column',
                  alignItems: 'center'
              })
          } else if (obj.style.display == 'inline-flex') {
              $(obj).slideToggle();
          }
      }

      function hideLogin() {

        $('#login-page').fadeOut().animate({
          display: 'none'
        });
        inlineToggle(document.getElementById('main'));

      }

    </script>

    <script type='text/javascript'>

      let value1 = (document.getElementById('selected-title').getBoundingClientRect().right - document.getElementById('selected-status').getBoundingClientRect().left + 40);
      $('#selected-status').css('left', (value1.toString().concat('px')));

      let value2 = (document.getElementById('selected-title').getBoundingClientRect().bottom - document.getElementById('selected-status').getBoundingClientRect().bottom);
      $("#selected-status").css('top', value2.toString().concat('px'));

      

    </script>

    <script type='text/javascript'>

      let taylorSheet;
      let ericaSheet;
      let emmaSheet;
      let livSheet;
      let brittanySheet;
      let haleySheet;
      let kennaSheet;
      let elyseSheet;

      function formatGenres(genres) {

          genres = genres.split(';');
          genres = genres.map(e => {return e.trim().toLowerCase()});
          return genres;

      }

      let testGenres = 'Historical Fiction;Sci-Fi; Romance';

      class Book {
          constructor(title, author, type, genres, status = 'N', seriesMember = 'N', comments = 'N', bookNumber = 'N', series = 'N', tw = 'N', cover = 'N') {
              this.title = title.toLowerCase();
              this.author = author.toLowerCase();
              this.type = type.toLowerCase();
              this.genres = formatGenres(genres);
              this.status = status.toLowerCase();
              this.seriesMember = seriesMember.toLowerCase();
              this.comments = comments.toLowerCase();
              this.bookNumber = bookNumber.toLowerCase();
              this.series = series.toLowerCase();
              this.tw = tw.toLowerCase();
              this.cover = cover.toLowerCase();
              this.alphabeticalTitle;
          }
          getAlphabetical() {
            return this.alphabeticalTitle;
          }
          setAlphabetical() {
            if (this.title.substring(0,3) == 'the ') {

              this.alphabeticalTitle = this.title.slice(4).concat(', the');

            } else {
              this.alphabeticalTitle = this.title;
            }
          }
      }

      let testBook = new Book('title', 'author', 'type', testGenres, 'stat', 'comments');


      class Series {
          constructor(title) {
              this.title = title.toLowerCase();
              this.books = [];
              this.alphabeticalTitle;
          }
          getBooks() {
              return this.books;
          }
          setBooks(value) {
              this.books.push(value);
          }
          getAlphabetical() {
            return this.alphabeticalTitle;
          }
          setAlphabetical() {
            if (this.title.substring(0,3) == 'the ') {

              this.alphabeticalTitle = this.title.slice(4).concat(', the');

            } else {
              this.alphabeticalTitle = this.title;
            }
          }
      }

      class Person {
          constructor(name, sheet) {
              this.name = name;
              this.sheet = sheet;
              this.bookshelf = name + "'s Bookshelf";
              this.books = [];
          }
          getSheet() {
              return this.sheet;
          }
          setSheet(value) {
              this.sheet = eval(value);
          }
      }

      let taylor = new Person("Taylor", 'taylorSheet');
      let erica = new Person("Erica", 'ericaSheet');
      let brittany = new Person("Brittany", 'brittanySheet');
      let emma = new Person("Emma", 'emmaSheet');
      let liv = new Person("Liv", 'livSheet');
      let haley = new Person("Haley", 'haleySheet');
      let kenna = new Person("Kenna", 'kennaSheet');
      let elyse = new Person("Elyse", 'elyseSheet');

      let peopleArray = [taylor, erica, emma, liv, brittany, haley, kenna, elyse];
      let bookArray = [];
      let seriesArray = [];

    </script>

    <script type="text/javascript">

        // You should set your Google client ID and Google API key
          const GOOGLE_CLIENT_ID = '568492347305-j8vnjb6h2a0m5ngeek8v5m98rq1o1c49.apps.googleusercontent.com';
          const GOOGLE_API_KEY = 'AIzaSyASnWe7SMdFOyFdAiP-ksrKAeYkVwajbeo';
          //
    
          const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
    
         // Authorization scope should be declared for spreadsheet handing
         // multiple scope can he included separated by space
          const SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';
    
          let tokenClient;
          let gapiInited = false;
          let gisInited = false;
          //document.getElementById('authorize_btn').style.visibility = 'hidden';
          //document.getElementById('signout_btn').style.visibility = 'hidden';
    
          /**
           * Callback after api.js is loaded.
           */
          function gapiLoaded() {
            gapi.load('client', intializeGapiClient);
          }
    
          /**
           * Callback after the Google API client is loaded. Loads the
           * discovery doc to initialize the API.
           */
          async function intializeGapiClient() {
            await gapi.client.init({
              apiKey: GOOGLE_API_KEY,
              discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
          }
    
          /**
           * Callback after Google Identity Services are loaded.
           */
          function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: GOOGLE_CLIENT_ID,
              scope: SCOPES,
              callback: '', // defined later
            });
            gisInited = true;
            maybeEnableButtons();
          }
    
          /**
           * Enables user interaction after all libraries are loaded.
           */
          function maybeEnableButtons() {
            if (gapiInited && gisInited) {
              //document.getElementById('authorize_btn').style.visibility = 'visible';
            }
          }
    
          /**
           *  Sign in the user upon button click.
           */
          function authorizeGoogleAccess() {
            tokenClient.callback = async (resp) => {
              if (resp.error !== undefined) {
                throw (resp);
              }
              hideLogin();
              await getBooks();
            };
    
            if (gapi.client.getToken() === null) {
              // Prompt the user to select a Google Account and ask for consent to share their data
              // when establishing a new session.
              tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
              // Skip display of account chooser and consent dialog for an existing session.
              tokenClient.requestAccessToken({prompt: ''});
            }
          }
    
          /**
           *  Sign out the user upon button click.
           */
          function signoutGoogle() {
            const token = gapi.client.getToken();
            if (token !== null) {
              google.accounts.oauth2.revoke(token.access_token);
              gapi.client.setToken('');
              document.getElementById('content').innerText = '';
              //document.getElementById('authorize_btn').innerText = 'Authorize';
              //document.getElementById('signout_btn').style.visibility = 'hidden';
            }
          }
    
          /**
           * Print the names and majors of students in a sample spreadsheet:
           * https://docs.google.com/spreadsheets/d/1aSSi9jk2gBEHXOZNg7AV7bJj0muFNyPLYwh2GXThvas/edit
           */
          async function getBooks() {

            try {
              // Fetch first 10 files
              taylorSheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Taylor\'s Bookshelf'!A:K",
              });
              ericaSheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Erica\'s Bookshelf'!A:K",
              });
              emmaSheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Emma\'s Bookshelf'!A:K",
              });
              livSheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Liv\'s Bookshelf'!A:K",
              });
              brittanySheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Brittany\'s Bookshelf'!A:K",
              });
              haleySheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Haley\'s Bookshelf'!A:K",
              });
              kennaSheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Kenna\'s Bookshelf'!A:K",
              });
              elyseSheet = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1HIfF-BjV1QrKhRusaQhtMzQbkKyHsAZsFLJHV7iquyM',
                range: "'Elyse\'s Bookshelf'!A:K",
              });
            } catch (err) {
              document.getElementById('content').innerText = err.message;
              return;
            }
            const range = taylorSheet.result;
            if (!range || !range.values || range.values.length == 0) {
              document.getElementById('content').innerText = 'No values found.';
              return;
            }
            console.log(range.values);
            console.log(ericaSheet.result.values);
            console.log(emmaSheet.result.values);
            console.log(livSheet.result.values);
            console.log(brittanySheet.result.values);
            console.log(haleySheet.result.values);
            console.log(kennaSheet.result.values);
            console.log(elyseSheet.result.values);

            taylorSheet = range.values;
            ericaSheet = ericaSheet.result.values;
            emmaSheet = emmaSheet.result.values;
            livSheet = livSheet.result.values;
            brittanySheet = brittanySheet.result.values;
            haleySheet = haleySheet.result.values;
            kennaSheet = kennaSheet.result.values;
            elyseSheet = elyseSheet.result.values;

            
            for (let i = 0; i < peopleArray.length; i++) {

                peopleArray[i].setSheet(peopleArray[i].getSheet());

                for (let j = 1; j < peopleArray[i].sheet.length; j++) {

                    if (!peopleArray[i].sheet[j].includes('Y')) {
                        let bookInfo = peopleArray[i].sheet[j];
                        let newBook =  new Book(bookInfo[0], bookInfo[1], bookInfo[2], bookInfo[3], bookInfo[4], bookInfo[5], bookInfo[6], bookInfo[7], bookInfo[8], bookInfo[9], bookInfo[10]);
                        newBook.setAlphabetical();
                        bookArray.push(newBook);

                    } else {
                        let bookInfo = peopleArray[i].sheet[j];
                        let newBook = new Book(bookInfo[0], bookInfo[1], bookInfo[2], bookInfo[3], bookInfo[4], bookInfo[5], bookInfo[6], bookInfo[7], bookInfo[8], bookInfo[9], bookInfo[10]);
                        if (seriesArray.some((e) => {return e.title == newBook.series})) {
                            let found = seriesArray.find((e) => {return e.title == newBook.series});
                            found.setBooks(newBook);
                        } else {
                            let newSeries = new Series(newBook.series);
                            newSeries.setBooks(newBook);
                            seriesArray.push(newSeries);
                        }

                        newBook.setAlphabetical();
                        bookArray.push(newBook);
                                
                        }


                    }

                }

            }
            console.log(bookArray);
            console.log(seriesArray);

        
        </script>

    <script async defer src='https://apis.google.com/js/api.js' onload='gapiLoaded()'></script>
    <script async defer src='https://accounts.google.com/gsi/client'onload='gisLoaded()'></script>
    
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

</body>




</html>